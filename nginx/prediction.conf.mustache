# Handle prediction data from Jenkins.
location ~ ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(api/v1(-(?P<branch>[-_0-9a-zA-Z]+))?)/ {
    {{{hub_branch}}}
    if ($branch = "") {
        set $branch "master";
    }
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/predict/jira/(?P<project>[^/]+)/sprint/(?P<sprint>\d+|latest)$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/$project/$sprint.json break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/predict/jira/(?P<project>[^/]+)/sprints$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/$project/sprints.json break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/list/jira$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/projects.json break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/list/meta$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/projects_meta.json break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/configuration$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/configuration.json break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/locale/(?P<locale>descriptions|tags|units|short_units|sources)$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/$locale.json break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/links/(?P<project>[^/]+)$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/$project/sources.json break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/links/(?P<project>[^/]+)/sprint/latest$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/$project/links.json break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}api/v1(-[-_0-9a-zA-Z]+)?/links/(?P<project>[^/]+)/sprint/(?P<sprint>\d+)$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/output/$project/links.$sprint.json break;
    proxy_pass http://{{#upstream}}jenkins:8080{{/upstream}};
    add_header Access-Control-Allow-Origin *;
}

location ~ ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(show|branch/(?P<branch>[-_0-9a-zA-Z]+))/zip {
    {{{hub_branch}}}
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(show|branch/[-_0-9a-zA-Z]+)/zip$ {{{jenkins_path}}}/job/create-prediction/job/$branch/lastSuccessfulBuild/artifact/*zip*/archive.zip break;
}

location ~ ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(show|branch/[-_0-9a-zA-Z]+)/ {
    {{{hub_branch}}}
    if ($branch = "") { set $branch "master"; }
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(?P<path>show|branch/[-_0-9a-zA-Z]+)/(?P<project>[^/]+)/$ {{#url}}{{{prediction_server}}}/{{{hub_redirect}}}{{{prediction_url}}}{{/url}}$path/$project permanent;

    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(show|branch/[-_0-9a-zA-Z]+)/(?P<project>[^/]+) {{{jenkins_path}}}/job/build-prediction-site/job/$branch/Visualization/index.html?project=$project break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(show|branch/[-_0-9a-zA-Z]+)/(?P<project>[^/]+)/sprint/(?P<sprint>\d+|latest) {{{jenkins_path}}}/job/build-prediction-site/job/$branch/Visualization/index.html?project=$project&sprint=$sprint break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(show|branch/[-_0-9a-zA-Z]+)(/[^/]+/sprint)?/(?P<path>.+) {{{jenkins_path}}}/job/build-prediction-site/job/$branch/Visualization/$path break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(show|branch/[-_0-9a-zA-Z]+)/$ {{{jenkins_path}}}/job/build-prediction-site/job/$branch/Visualization/index.html break;
    proxy_pass http://{{#upstream}}jenkins:8080{{/upstream}}$uri;
}

location ~ ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}branches {
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}branches {{{jenkins_path}}}/job/create-prediction/api/json?tree=jobs[name,color,lastSuccessfulBuild[timestamp]] break;
    add_header Access-Control-Allow-Origin *;
    proxy_pass http://{{#upstream}}jenkins:8080{{/upstream}};
}

location ~ {{#path}}{{{prediction_url}}}{{/path}}papers/.*$ {
    rewrite ^{{#path}}{{{prediction_url}}}{{/path}}papers/(.*) /index.php/s/{{{files_share_id}}}/download?path=%2F&files=$1? break;
    proxy_hide_header Content-Disposition;
    proxy_intercept_errors on;
    proxy_pass http://{{#upstream}}owncloud{{/upstream}};
}

location ~ ^{{#path}}{{{prediction_url}}}{{/path}}files {
    rewrite ^{{#path}}{{{prediction_url}}}{{/path}}files /index.php/apps/files_sharing/ajax/list.php?t={{{files_share_id}}}&dir=%2F&sort=name&sortdirection=asc break;
    add_header Access-Control-Allow-Origin *;
    proxy_pass http://{{#upstream}}owncloud{{/upstream}};
}

autoindex off;
rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(index\.html|show|papers/?)?$ {{#url}}{{{prediction_server}}}/{{{hub_redirect}}}{{{prediction_url}}}{{/url}}show/ permanent;
rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}zip$ {{#url}}{{{prediction_server}}}/{{{hub_redirect}}}{{{prediction_url}}}{{/url}}show/zip permanent;

proxy_intercept_errors on;

error_page 401 {{{hub_redirect}}}/401.html;
error_page 403 {{{hub_redirect}}}/403.html;
error_page 404 {{{hub_redirect}}}/404.html;
error_page 500 502 503 504 {{{hub_redirect}}}/50x.html;

location ~ ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}} {
    {{{hub_branch}}}
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(?P<file>.+\.css|.+\.js.*) {{{jenkins_path}}}/job/build-prediction-site/job/$branch/Visualization/$file break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{prediction_url}}}{{/path}}(?P<file>.+) {{{jenkins_path}}}/job/build-visualization-site/job/$branch/Visualization/$file break;
    proxy_pass http://{{#upstream}}jenkins:8080{{/upstream}};
}
