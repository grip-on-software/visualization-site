location ~ ^{{#path}}{{{visualization_url}}}{{/path}}login {
    return 403;
}

# Handle visualizations from Jenkins. The job name must start with
# "build-" and the remainder is the name in the URL path. The job is
# a multibranch pipeline job which generates an HTML report for the
# master branch, using the publishHTML post build step from the HTML
# Publisher plugin, with the name "Visualization" and an index page of
# index.html.
location ~ ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}({{#join}}{{#visualization_names}}{{{.}}}|{{/visualization_names}}{{/join}})(/|\.zip) {
    {{{hub_branch}}}
    rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}(?P<name>[^/]+)\.zip$ {{{jenkins_path}}}/job/build-$name/job/$branch/Visualization/*zip*/$name.zip break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}(?P<name>[^/]+)/$ {{{jenkins_path}}}/job/build-$name/job/$branch/Visualization/index.html break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}(?P<name>[^/]+)/(?P<file>.+) {{{jenkins_path}}}/job/build-$name/job/$branch/Visualization/$file break;
    proxy_pass http://{{#upstream}}jenkins:8080{{/upstream}};
}

location ~ ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}encrypt {
    rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}encrypt /auth/encrypt.py break;
    proxy_pass "https://127.0.0.1";
    proxy_ssl_verify off;
    add_header Access-Control-Allow-Origin *;
}

location ~ ^{{#path}}{{{visualization_url}}}{{/path}}analytics {
    set_real_ip_from {{{proxy_range}}};
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;
    {{#allow_range}}
    allow {{{.}}};
    {{/allow_range}}
    deny all;
    root /srv/goaccess-report;
    autoindex on;
    access_log /var/log/nginx/analytics_access.log;
}

rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}view {{#url}}{{{visualization_server}}}/{{{hub_redirect}}}{{{visualization_url}}}{{/url}} permanent;
rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}job {{#url}}{{{visualization_server}}}/{{{hub_redirect}}}{{{visualization_url}}}{{/url}} permanent;
rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}(?P<name>[_0-9a-zA-Z-]+)$ {{#url}}{{{visualization_server}}}/{{{hub_redirect}}}{{{visualization_url}}}{{/url}}$name/ permanent;

proxy_intercept_errors on;

error_page 404 /404.html;
error_page 500 502 503 504 /50x.html;

location ~ ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}(manifest\.js|vendor\.js|navbar\.css|fonts/) {
    {{{hub_branch}}}
    add_header Access-Control-Allow-Origin *;
    rewrite {{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}(?P<file>.+) {{{jenkins_path}}}/job/build-visualization-site/job/$branch/Visualization/$file break;
    proxy_pass http://{{#upstream}}jenkins:8080{{/upstream}};
}

location ~ ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}} {
    {{{hub_branch}}}
    rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}}(?P<file>.+) {{{jenkins_path}}}/job/build-visualization-site/job/$branch/Visualization/$file break;
    rewrite ^{{{hub_regex}}}{{#path}}{{{visualization_url}}}{{/path}} {{{jenkins_path}}}/job/build-visualization-site/job/$branch/Visualization/index.html break;
    proxy_pass http://{{#upstream}}jenkins:8080{{/upstream}};
}
